name: Verify skill installs

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref (tag/branch/sha) to install from"
        required: false
        default: "main"
  workflow_call:
    inputs:
      ref:
        required: true
        type: string

permissions:
  contents: read

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22.12.0"

      - name: Mock home and tool dirs
        shell: bash
        run: |
          set -euo pipefail
          mock_home="$RUNNER_TEMP/mock-home"
          mkdir -p "$mock_home"
          echo "HOME=$mock_home" >> "$GITHUB_ENV"
          echo "CODEX_HOME=$mock_home/.codex" >> "$GITHUB_ENV"
          echo "CLAUDE_CODE_HOME=$mock_home/.claudecode" >> "$GITHUB_ENV"
          echo "OPENCLAW_HOME=$mock_home/.openclaw" >> "$GITHUB_ENV"
          echo "CURSOR_SKILLS_DIR=$mock_home/.cursor/skills" >> "$GITHUB_ENV"
          mkdir -p \
            "$mock_home/.codex/skills" \
            "$mock_home/.claudecode/skills" \
            "$mock_home/.openclaw/skills" \
            "$mock_home/.cursor/skills"

      - name: Install public skills
        shell: bash
        env:
          REF_INPUT: ${{ inputs.ref }}
        run: |
          set -euo pipefail
          ref="${REF_INPUT:-main}"
          repo="$(python3 - <<'PY'
          import json
          with open("releases/skills.json", "r", encoding="utf-8") as f:
              data = json.load(f)
          print(data["repo"])
          PY
          )"
          base_url="https://github.com/${repo}/tree/${ref}"
          python3 - <<'PY' "$base_url"
          import json
          import subprocess
          import sys

          base_url = sys.argv[1]
          with open("releases/skills.json", "r", encoding="utf-8") as f:
              data = json.load(f)
          for item in data.get("skills", []):
              name = item["name"]
              cmd = ["npx", "-y", "skills", "add", base_url, "--skill", name, "-y", "--global"]
              print("::group::install", name)
              subprocess.run(cmd, check=True)
              print("::endgroup::")
          PY

      - name: List public skills
        shell: bash
        env:
          REF_INPUT: ${{ inputs.ref }}
        run: |
          set -euo pipefail
          ref="${REF_INPUT:-main}"
          repo="$(python3 - <<'PY'
          import json
          with open("releases/skills.json", "r", encoding="utf-8") as f:
              data = json.load(f)
          print(data["repo"])
          PY
          )"
          npx -y skills add "https://github.com/${repo}/tree/${ref}" --list
